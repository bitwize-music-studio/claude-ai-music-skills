name: Auto Release

on:
  push:
    branches:
      - main
    paths:
      - '.claude-plugin/plugin.json'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      with:
        fetch-depth: 0  # Full history for tagging

    - name: Extract version
      id: version
      run: |
        VERSION=$(jq -r '.version' .claude-plugin/plugin.json)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"

    - name: Check if tag exists
      id: check_tag
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        if git rev-parse "v$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag v$VERSION already exists, skipping release"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag v$VERSION does not exist, proceeding with release"
        fi

    - name: Extract release notes from CHANGELOG
      id: changelog
      if: steps.check_tag.outputs.exists == 'false'
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        # Extract everything between [VERSION] and the next ## heading
        NOTES=$(awk -v ver="$VERSION" '
          $0 ~ "## \\[" ver "\\]" { found=1; next }
          found && /^## \[/ { exit }
          found { print }
        ' CHANGELOG.md | head -c 65000)

        # Trim leading/trailing whitespace
        NOTES=$(printf '%s' "$NOTES" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

        # If empty or only whitespace, use default message
        if [ -z "$NOTES" ]; then
          NOTES="Release $VERSION"
        fi

        # Save to file to preserve formatting
        printf '%s\n' "$NOTES" > /tmp/release_notes.md
        echo "Release notes extracted from [$VERSION] section"

    - name: Create GitHub Release
      if: steps.check_tag.outputs.exists == 'false'
      env:
        GH_TOKEN: ${{ github.token }}
        VERSION: ${{ steps.version.outputs.version }}
        TAG: ${{ steps.version.outputs.tag }}
      run: |
        # Determine if pre-release (0.x.x versions)
        if [[ "$VERSION" =~ ^0\. ]]; then
          PRERELEASE="--prerelease"
        else
          PRERELEASE=""
        fi

        gh release create \
          "$TAG" \
          --title "$VERSION" \
          --notes-file /tmp/release_notes.md \
          $PRERELEASE

    - name: Verify CHANGELOG was updated
      if: steps.check_tag.outputs.exists == 'false'
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        # Check if this version exists in CHANGELOG
        if grep -q "## \[$VERSION\]" CHANGELOG.md; then
          echo "[OK] CHANGELOG.md contains release notes for version $VERSION"
        else
          echo "[WARN] CHANGELOG.md does not contain section for version $VERSION"
          echo ""
          echo "The release was created, but please update CHANGELOG.md manually:"
          echo "1. Rename [Unreleased] to [$VERSION] - $(date +%Y-%m-%d)"
          echo "2. Add new [Unreleased] section above it"
          echo "3. Commit and push to main"
        fi
